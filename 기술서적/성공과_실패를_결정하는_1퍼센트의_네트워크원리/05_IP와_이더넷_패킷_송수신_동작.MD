## 05. IP와 이더넷의 패킷 송수신 동작



#### 1. 패킷의 기본

- TCP는 접속, 송수신, 연결 끊기의 각 단계에서 통신 상대와 대화할 때 IP 담당 부분에 의뢰하여 대와하는 데이터를 패킷의 모습으로 만들어 상대에게 도착한다.
- 패킷은 **헤더와 데이터** 두 부분으로 구성된다.

- 패킷은 송신처가 되는 기기가 패킷을 만들며, 헤더에는 적절한 제어 정보를 기록하고, 데이터를 넣은 후 **가장 가까운 중계 장치에 송신**한다.
- 중계 장치는 도착한 패킷 헤더를 조사하여 패킷의 목적지를 확인후 중계 장치에 기록된 표의 내용을 결합하여 패킷의 목적지를 판단 후 송신힌다.
- 다음 중계 장치 또한 패킷을 수신하고 위와 같은 원리로 패킷을 전송하면 결국 패킷이 최종 도착지에 전달된다, 이것이 패킷의 기본 통신 방식이다.
- 혀브는 이더넷의 규칙이 따라서 패킷을 운반하고, 라우터는 IP 규칙에 따라서 패킷을 운반한다.
- MAC 헤더는 이더넷용 헤더, IP 헤더는 IP용 헤더라 말할 수 있다.

<br><br>



#### 2. 패킷 송수신 동작의 개요

![image-20241215145940253](https://github.com/user-attachments/assets/f6a74cfe-b4c8-4de2-901b-7c3c76452e68)


- **IP 담당** 부분은 패킷을 상대에게 송출하기만 하고 상대가 있는 곳까지 패킷을 운반하는 것은 **허브나 라우터** 같은 네트워크 기기 역할이다.
- TCP 담당 부분은 데이터 조각에 TCP 헤더를 부가한 것을 IP 담당에게 건네준다.
- IP 딤딩 부분은 내용물을 한 덩어리의 **디지털 데이터로 간주**하고, 그 앞에 제어 정보인 **IP 헤더와 MAC 헤더**를 부가한다.
- IP 헤더는 IP 프로토콜에 규정된 규칙에 따라 IP 주소로 표시된 목적지까지 패킷을 전달할 때 사용하는 제어 정보를 기록한 것이다.
- **MAC 헤더**는 이더넷 등의 LAN을 사용하여 **가장 가까운 라우터까지 패킷을 운반할 때 사용하는 제어 정보**를 기록한 것이다.
- 이후 만든 패킷을 네트워크용 하드웨어인 이더넷이나 무선 LAN 에게 건네준다.(LAN 어뎁터)
- LAN 어뎁터에 의해 디지털 데이터는 전기나 빛의 신호 상태로 바뀌어 케이블로 송출되며, 허브나 라우터 같은 중계 장치에 도착한다.
- 중계 장치에 패킷이 수신되면 디지털 데이터의 모습으로 되돌린다.
- 그리고 디지털 데이터 패킷을 IP 담당 부분에게 건네준다.
- 그러면 IP 담당 부분이 TCP 헤더와 데이터 조각을 TCP 담당에게 건네준다. 여기까지가 전체적인 개요다.
- IP 담당 부분은 TCP 헤더와 데이터 조각을 한 덩어리의 바이너리 데이터로 간주하여 내용을 보지 않고 송수신 동작을 실행한다.
- TCP의 동작, 데이터의 존재유무 순서 이런것은 상관하지 않고 의뢰받은 내용물을 패킷의 형태로 만들어 상대에게 전달하거나 수신할 뿐이다. 이것이 IP 동작의 공통점이다.

<br><br>



#### 3. 수신처 IP 주소를 기록한 IP 헤더를 만든다.

- IP는 스스로 수신처를 판단하지 않고 어플리케이션에서 통지된 수신처 IP를 그대로 IP 헤더에 기입한다. 때문에 수신 IP 오동작시 어플리케이션에 책임이 있는것으로 간주한다.
- 송신처 IP 주소는 LAN 어댑터를 판단하여 주소를 설정한다.(LAN 어댑터 마다 서로 다른 IP주소가 할당되어 있다.(LAN 어댑터마다 다른 IP 주소가 할당되어 있다.)
- 패킷을 건네줄 상대를 판단하는 방법은 라우터가 IP용 테이블을 이용하여 다음 라우터를 결정한다.

- 게이트웨이는 다음 라우터의 IP 주소를 기록하게 되어 있어서 IP 주소를 가진 라우터에 패킷을 건네주면 라우터가 목적지에 패킷을 중계한다.(만약 내가 192.168.1.11로 패킷을 전송하고 싶다면 192.168.1.x 로 지정된 게이트웨이를 설설정하면 된다.)
- 게이트웨이는 TCP/IP 세계에서 라우터를 가리키는 용어이다.
- 만약 라우터를 나타내는 게이트웨이와 interface의 IP 주소가 같다면 라우터로 중계하지 않고 상대에게 직접 패킷을 전할 수 있는 것이 된다.



#### 4. 이더넷용 MAC 헤더를 만든다.

![image-20241215145954653](https://github.com/user-attachments/assets/73bbab89-33d8-4634-a0ea-b8e0aa0a533a)

- 이더넷은 TCP/IP와 다른 구조로 페킷의 수신처를 판단하며, 이 구조를 따르지 않으면 패킷을 운반하지 않는다. 이더넷의 수신처 판단 구조로 사용하는 것이 MAC 헤더이다.
- MAC 헤더에서 송신처 MAC 주소는 자체의 LAN 어댑터의 MAC 주소를 설정한다.
- MAC 주소는 LAN 어댑터를 제조할 때 그 안에 있는 ROM에 기록되므로 여기에 기록되어 있는 값을 읽어와서 MAC 헤더로 설정한다.
- 수신처 MAC 주소는 패킷을 건네줄 상대를 IP 주소를 통해서 MAC 주소를 조사하는 동작을 실행한다.



<br><br>



#### 5. ARP로 수신처 라우터의 MAC 주소를 조사한다.

- 자신과 같은 네트워크에 존재하는 전원에게 브로드캐스트로 **IP 주소로 MAC 주소**를 찾는 행위를 한다.
- 그런데 항상 주소를 찾는 행위를 하지 않으며 일단 **ARP 캐시**를 조사해서 MAC 주소를 찾고 만약 없으면 **브로드캐스트**로 물어보는 행위를 한다.
- ARP 캐시의 경우 **동기화 문제**(IP가 달라질 경우)로 인해서 무제한으로 사용할 수 없으며, OS 종류에 따라서 다르지만 몇분 경과한 **ARP 캐시**를 삭제한다. 무조건 삭제하는것이 난폭하지만 문제가 되진 않는다.
- 위와 같은 행위로 MAC 헤더를 만들기까지가 IP 담당 부분의 역할이다.
- LAN 어댑터에 건네주기 전에 IP 담당 부분에서 패킷을 완성하면 LAN 어댑터는 완성된 패킷만 송신한다.



<br><br>



#### 6. 이더넷의 기본

- 이더넷은 다수의 컴퓨터가 여러 상대와 자유롭게 적은 비용으로 통신하기 위해 고안된 통신 기술이다.
- MAC 헤더로 누구에게 패킷이 갈 것인지 알고, 누가 송신한 것인지 알며, 이더 타입에 의해 패킷의 내용물로 무엇이 들어있는지 아는 것이다. 이것이 이더넷이다.



<br><br>



#### 7. IP 패킷을 전기나 빛의 신호로 변환하여 송신한다.

- 이더넷 패킷의 송수신 동작을 설명한다.
- IP가 만든 패킷은 메모리에 기억된 **디지털 데이터**이므로 이것을 **전기나 빛의 신호로 변환**하여 네트워크 케이블로 송출하는 것이 송수신 동작의 본질이다.
- 해당 동작을 실행하는 것이 LAN 어댑터이며, LAN 드라이버 같은 소프트웨어와 같이 동작한다.

![image-20241215150447108](https://github.com/user-attachments/assets/1b0ba3cb-9907-4c41-8c04-c24ad5df2a22)

- **LAN 어댑터**는 전원 공급시 바로 사용할 수 없으며, 초기화 작업 이후에 사용 가능하다.
- 전원 공급후 OS가 동작할 때 **LAN 드라이버**가 LAN 어댑터 같은 하드웨어 초기화 작업을 수행한다.
- 이더넷 특유의 작업도 존재하는데 이더넷 송수신 동작을 제어하는 MAC 회로에 MAC 주소를 설정하는 것이다.
- LAN 어댑터의 **ROM**에는 MAC 주소가 있고 이것을 읽어와서 **MAC 회로**에 설정한다. 이것은 **LAN 드라이버**가 초기화 작업의 일환으로 하는 것이다.
- OS를 기동할 때 이 초기화 작업을 끝낸 후 IP 에서 의뢰하기를 기다린다.



<br><br>

#### 8. 패킷에 3개의 제어용 데이터를 추가한다.

![image-20241215151130214](https://github.com/user-attachments/assets/1bd61980-2495-48b7-8845-46e37dcfb516)

- LAN 드라이버는 IP 담당 부분에서 패킷을 받으면 그것을 **LAN 어댑터의 버퍼 메모리**에 복사한다.
- 복사를 마친 후 패킷을 송신하도록 MAC 회로에 명령을 보내면 MAC 회로의 작업이 시작된다.
- **MAC 회로**는 송신 패킷의 버퍼 메모리에서 추출하고 맨 앞에 **프리앰블**과 **스타트 프레임 딜리미터**, 맨 끝에는 **프레임 체크 시퀀스(FCS)**라는 오류 검출용 데이터를 부가한다.
- **프리앰블**은 송신하는 패킷을 읽을 때의 타이밍을 잡기 위한 것으로 1과0이 번갈아 나타나는 56비트 비트열이다.
- 프리앰블로 타이밍을 맞추고 **SFD(스타트 프레임 딜리미터)**로 프레임의 개시 위치를 발견한다.(SFD는 비트단위로 11로 끝나기 때문에 파형을 판단해서 패킷 의 시작 위치로 간주한다.)
- **FCS**는 디스크 장치 등에 사용하는 오류 검사 코드인 계산 값이 적용되어 있어서 패킷 운반 도중 잡음 등의 영향으로 내용의 데이터가 변하면 수신측에서 계산한 FCS가 송신할 때 계산한 것과 다른 값이 된다. 이러한 불일치를 통해 데이터의 변화 사실을 검출하는 것이다.

<br><br>

#### 9. 허브를 향해 패킷을 송신한다.

- 프리앰블, 스타트 프레임 딜리미터, FCS 세 가지를 부가하면 케이블에 송출하는 패킷이 완성된다.
- 신호를 송신하는 동작에는 리피터 허브를 사용했을 때의 반이중 모드, 스위칭 허브를 사용한 전이중 모드 2가지가 있다.
- 반이중 모드는 케이블에 다른 기기가 송신한 신호가 흐르고 있는지 조사하고, 신호가 흐르고 있으면 그것이 끝날때 까지 기다린다.(신호가 흐르고 있을때 송신 동작을 시작하면 신호가 충돌한다.)
- 신호가 정지했거나 애초부터 신호가 흐르지 않았다면 송신 동작을 시작한다.
- **반이중 모드**는 송수신을 동시에 실행해도 충돌은 일어나지 않는다.

<br><br>

#### 10. 돌아온 패킷을 받는다.

- 신호의 맨 앞에는 **프리앰블**이 있으므로 파형에서 **타이밍을 계산**하여 스타트 프레임 딜리미터가 나오면 그 다음 **디지털 데이터**로 변환하여 동작을 게시한다.
- **MAU 회로**에서 신호를 공통 형식으로 변환하여 **MAC 회로**에 보내고 MAC 회로에서 신호를 맨 앞부터 차례대로 **디지털 데이터**로 변환하여 **버퍼 메모리**에 저장한다.
- 그리고 신호의 마지막에 이르면 맨 끝의 FCS를 검사한다, 구체적으론 패킷의 맨 앞에서 부터 계산식을 적용하여 FCS 값을 구하고 패킷 끝의 FCS 값과 비교하여 일치하지 않으면 오류 패킷으로 간주하여 폐기한다.
- **FCS**에 문제가 없으면 MAC 헤더의 수신처 MAC 주소를 조사하여 LAN 어댑터를 초기화 할 때 설정한 자체 **MAC 주소**와 비교하여 자신에게 오는 것인지 판단한다.
- 다른 곳에 갈 패킷은 수신할 필요가 없으므로 **폐기**한다.
- **수신처 MAC 주소**가 자신에게 오는 것인 경우만 패킷을 받아 **버퍼 메모리**에 저장한다.
- 이렇게 햐소 **MAC 회로**가 할 일이 끝나면 패킷을 수신한 사실을 **컴퓨터 본체에 통지**한다.
- 이 통지는 **인터럽트**라는 구조를 사용한다. 컴퓨터 본체가 실행하고 있는 작업에 끼어들어 LAN 어댑터쪽에 주의시키는 것이 인터럽트 이다.
- 구체적으로는 먼저 **LAN 어댑터**가 **확장 버스 슬롯** 부분에 있는 **인터럽트용 신호선**에 신호를 보낸다.
- 이 신호선은 컴퓨터 본체측의 인터럽트 컨트롤러를 통해 **CPU**에 연결되어 있으며, 신호가 흘러오면 CPU는 실행하고 있던 작업을 일시적으로 보류하고 **OS 내부의 인터럽트 처리용 프로그램**쪽으로 전환한다.
- 여기서 **LAN 드라이버**가 호출되어 **LAN 어댑터**를 제어하면서 송수신 동작을 실행한다.

<br><br>

#### 11. 서버의 응답 패킷을 IP에서 TCP로 넘긴다,

- 서버에서 반송된 페킷의 타입은 **0800(ip 프로토콜)**이므로 LAN 드라이버는 TCP/IP의 프로토콜 스택에 패킷을 건넨다.
- IP 담당 부분은 IP 헤더를 조사하여 포멧에 문제가 없는지 확인하고, 수신처 IP를 조사한다.
- 패킷을 수신한 기기가 윈도우의 클라이언트 PC이면, 서버에서 회신된 수신처 IP 주소는 수신한 LAN 어댑터에 할당된 주소와 일치할 것이고 이것을 확인하고 패킷을 수신한다.
- 만약 수신처 IP 주소가 자신의 주소와 다르다면 **ICMP** 메시지를 사용하여 통신 상대에게 오류를 통지한다.
- IP 프로토콜에는 **조각 나누기** 라는 기능이 존재한다.
- 패킷 운반 도중에 있는 통신 회선이나 짧은 패킷만 다룰 수 있는 LAN이 있다. 이런경우 패킷을 짧게 하기 위해 하나의 패킷을 여러 개로 분할 하는 경우가 있다.
- 분할된 패킷은 IP 헤더에 있는 플래그라는 항목으로 확인 가능하며 수신 패킷이 분할된 것이면 IP 담당 부분 내부의 메모리에 일시적으로 보관한다.
- 그리고 IP 헤더에 있는 ID 정보에 같은 값을 가진 패킷이 도착하기를 기다리고 분할된 패킷은 ID 정보의 값이 모두 같은 값인 패킷이므로 참조한다.
- **프래그먼트 오프셋** 이라는 항목에는 패킷이 원래 패킷의 어느 위치에 있었는지를 나타내는 정보가 들어있다. 이 정보를 바탕으로 분할된 패킷이 전부 도착하기를 기다렸다가 패킷의 원래 모습으로 되돌리는 동작을 **리어셈블링** 이라고 한다. 이것을 IP 담당 부분의 역할은 끝나고 리어셈블링이 끝나면 패킷읊 TCP 담당 부분에게 건네준다.
- TCP 담당 부분은 IP 헤더에 기록된 **수신처 IP 주소와 송신처 IP 주소, TCP 헤더에 기록된 수신처 포트 번호 및 송신처 포트 번호 4가지 항목을 조사**하여 해당하는 소켓을 찾는다.
- 소켓을 찾아내면 통신의 진행 상태가 기록되어 있으므로 상황에 따라 적절한 동작을 실행한다.
